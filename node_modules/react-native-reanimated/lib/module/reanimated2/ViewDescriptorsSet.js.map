{"version":3,"names":["useRef","makeMutable","shouldBeUseWeb","scheduleUpdates","requestAnimationFrame","setImmediate","makeViewDescriptorsSet","ref","current","data","batchToRemove","Set","tags","waitForInsertSync","waitForRemoveSync","sharableViewDescriptors","items","add","item","has","tag","push","value","remove","viewTag","delete","rebuildsharableViewDescriptors","makeViewsRefSet"],"sources":["ViewDescriptorsSet.ts"],"sourcesContent":["import { useRef } from 'react';\nimport { makeMutable } from './core';\nimport { SharedValue } from './commonTypes';\nimport { Descriptor } from './hook/commonTypes';\nimport { shouldBeUseWeb } from './PlatformChecker';\n\nexport interface ViewRefSet<T> {\n  items: Set<T>;\n  add: (item: T) => void;\n  remove: (item: T) => void;\n}\n\nexport interface ViewDescriptorsSet {\n  batchToRemove: Set<number>;\n  tags: Set<number>;\n  waitForInsertSync: boolean;\n  waitForRemoveSync: boolean;\n  sharableViewDescriptors: SharedValue<Descriptor[]>;\n  items: Descriptor[];\n  add: (item: Descriptor) => void;\n  remove: (viewTag: number) => void;\n  rebuildsharableViewDescriptors: (\n    sharableViewDescriptor: SharedValue<Descriptor[]>\n  ) => void;\n}\n\nconst scheduleUpdates = shouldBeUseWeb() ? requestAnimationFrame : setImmediate;\n\nexport function makeViewDescriptorsSet(): ViewDescriptorsSet {\n  const ref = useRef<ViewDescriptorsSet | null>(null);\n  if (ref.current === null) {\n    const data: ViewDescriptorsSet = {\n      batchToRemove: new Set(),\n      tags: new Set(),\n      waitForInsertSync: false,\n      waitForRemoveSync: false,\n      sharableViewDescriptors: makeMutable([]),\n      items: [],\n\n      add: (item: Descriptor) => {\n        if (data.tags.has(item.tag)) {\n          return;\n        }\n        data.tags.add(item.tag);\n        data.items.push(item);\n\n        if (!data.waitForInsertSync) {\n          data.waitForInsertSync = true;\n\n          scheduleUpdates(() => {\n            data.sharableViewDescriptors.value = data.items;\n            data.waitForInsertSync = false;\n          });\n        }\n      },\n\n      remove: (viewTag: number) => {\n        data.batchToRemove.add(viewTag);\n\n        if (!data.waitForRemoveSync) {\n          data.waitForRemoveSync = true;\n\n          scheduleUpdates(() => {\n            const items = [];\n            for (const item of data.items) {\n              if (data.batchToRemove.has(item.tag)) {\n                data.tags.delete(item.tag);\n              } else {\n                items.push(item);\n              }\n            }\n            data.items = items;\n            data.sharableViewDescriptors.value = items;\n            data.batchToRemove = new Set();\n            data.waitForRemoveSync = false;\n          });\n        }\n      },\n\n      rebuildsharableViewDescriptors: (\n        sharableViewDescriptors: SharedValue<Descriptor[]>\n      ) => {\n        data.sharableViewDescriptors = sharableViewDescriptors;\n      },\n    };\n    ref.current = data;\n  }\n\n  return ref.current;\n}\n\nexport function makeViewsRefSet<T>(): ViewRefSet<T> {\n  const ref = useRef<ViewRefSet<T> | null>(null);\n  if (ref.current === null) {\n    const data: ViewRefSet<T> = {\n      items: new Set(),\n\n      add: (item: T) => {\n        if (data.items.has(item)) return;\n        data.items.add(item);\n      },\n\n      remove: (item: T) => {\n        data.items.delete(item);\n      },\n    };\n    ref.current = data;\n  }\n\n  return ref.current;\n}\n"],"mappings":"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"}